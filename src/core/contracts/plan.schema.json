{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://aura.dev/schemas/plan.v1.json",
  "version": "1.0.0",
  "title": "Plan",
  "description": "Execution plan generated by Aura for a given task",
  "type": "object",
  "required": ["id", "version", "taskId", "steps", "estimatedDuration", "risks"],
  "additionalProperties": false,
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^plan-[a-z0-9]{8}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}$",
      "description": "Unique plan identifier (UUID v4 with 'plan-' prefix)"
    },
    "version": {
      "type": "string",
      "enum": ["1.0.0"],
      "description": "Schema version this plan adheres to"
    },
    "taskId": {
      "type": "string",
      "pattern": "^task-[a-z0-9]{8}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}$",
      "description": "ID of the task this plan executes"
    },
    "steps": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["id", "agent", "action", "inputs", "outputs", "validation"],
        "additionalProperties": false,
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^step-[0-9]{3}$",
            "description": "Step identifier (e.g., step-001)"
          },
          "agent": {
            "type": "string",
            "enum": ["orchestrator", "architect", "developer", "database", "reviewer", "tester", "devops", "documenter"],
            "description": "Which agent executes this step"
          },
          "action": {
            "type": "string",
            "minLength": 10,
            "maxLength": 200,
            "description": "What this step does"
          },
          "inputs": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Input files or data for this step"
          },
          "outputs": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Expected output files or artifacts"
          },
          "validation": {
            "type": "object",
            "required": ["command", "successCriteria"],
            "properties": {
              "command": {
                "type": "string",
                "description": "Command to verify step completion"
              },
              "successCriteria": {
                "type": "string",
                "description": "What success looks like"
              }
            }
          },
          "dependencies": {
            "type": "array",
            "items": {
              "type": "string",
              "pattern": "^step-[0-9]{3}$"
            },
            "description": "Step IDs that must complete before this one"
          }
        }
      }
    },
    "estimatedDuration": {
      "type": "integer",
      "minimum": 30,
      "description": "Estimated total execution time in seconds"
    },
    "risks": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["description", "severity", "mitigation"],
        "properties": {
          "description": {
            "type": "string",
            "minLength": 10
          },
          "severity": {
            "type": "string",
            "enum": ["low", "medium", "high", "critical"]
          },
          "mitigation": {
            "type": "string",
            "minLength": 10
          }
        }
      }
    },
    "contractChanges": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["file", "type", "breaking"],
        "properties": {
          "file": {
            "type": "string"
          },
          "type": {
            "type": "string",
            "enum": ["schema", "interface", "api", "config"]
          },
          "breaking": {
            "type": "boolean"
          },
          "description": {
            "type": "string"
          }
        }
      }
    },
    "metadata": {
      "type": "object",
      "properties": {
        "createdAt": {
          "type": "string",
          "format": "date-time"
        },
        "approved": {
          "type": "boolean",
          "default": false
        },
        "approvedBy": {
          "type": "string"
        },
        "approvedAt": {
          "type": "string",
          "format": "date-time"
        }
      }
    }
  },
  "examples": [
    {
      "id": "plan-f1e2d3c4-b5a6-7980-cdef-123456789abc",
      "version": "1.0.0",
      "taskId": "task-a1b2c3d4-e5f6-7890-abcd-ef1234567890",
      "steps": [
        {
          "id": "step-001",
          "agent": "architect",
          "action": "Design authentication architecture using Supabase Auth",
          "inputs": ["docs/requirements.md"],
          "outputs": ["docs/architecture/auth.md", "DECISIONS.md"],
          "validation": {
            "command": "grep -q 'Supabase Auth' docs/architecture/auth.md",
            "successCriteria": "Architecture document exists and includes Supabase Auth design"
          }
        },
        {
          "id": "step-002",
          "agent": "database",
          "action": "Verify database schema supports auth (users table, RLS policies)",
          "inputs": ["prisma/schema.prisma"],
          "outputs": ["prisma/migrations/add_auth_policies.sql"],
          "validation": {
            "command": "psql $DATABASE_URL -c \"SELECT * FROM pg_policies WHERE tablename='users'\"",
            "successCriteria": "RLS policies exist for users table"
          },
          "dependencies": ["step-001"]
        },
        {
          "id": "step-003",
          "agent": "developer",
          "action": "Implement auth routes (signup, login, logout) with TypeScript",
          "inputs": ["docs/architecture/auth.md"],
          "outputs": [
            "src/lib/auth.ts",
            "src/app/api/auth/signup/route.ts",
            "src/app/api/auth/login/route.ts",
            "src/app/api/auth/logout/route.ts"
          ],
          "validation": {
            "command": "npm run type-check",
            "successCriteria": "TypeScript compiles with no errors"
          },
          "dependencies": ["step-002"]
        },
        {
          "id": "step-004",
          "agent": "tester",
          "action": "Test authentication flows (signup, login, logout, edge cases)",
          "inputs": ["src/app/api/auth/**/*.ts"],
          "outputs": ["tests/integration/auth.test.ts"],
          "validation": {
            "command": "npm test -- auth.test.ts",
            "successCriteria": "All auth tests pass"
          },
          "dependencies": ["step-003"]
        },
        {
          "id": "step-005",
          "agent": "reviewer",
          "action": "Review auth implementation for security vulnerabilities",
          "inputs": ["src/lib/auth.ts", "src/app/api/auth/**/*.ts"],
          "outputs": ["docs/reviews/auth-security-review.md"],
          "validation": {
            "command": "grep -q 'APPROVED' docs/reviews/auth-security-review.md",
            "successCriteria": "Security review completed and approved"
          },
          "dependencies": ["step-004"]
        },
        {
          "id": "step-006",
          "agent": "documenter",
          "action": "Log authentication architecture decision in DECISIONS.md",
          "inputs": ["docs/architecture/auth.md"],
          "outputs": ["DECISIONS.md"],
          "validation": {
            "command": "grep -q 'Authentication: Supabase Auth' DECISIONS.md",
            "successCriteria": "Decision logged with context and rationale"
          },
          "dependencies": ["step-005"]
        }
      ],
      "estimatedDuration": 1800,
      "risks": [
        {
          "description": "Supabase Auth rate limits could block signup during high traffic",
          "severity": "medium",
          "mitigation": "Implement client-side rate limiting and queue system"
        },
        {
          "description": "RLS policies might not cover all edge cases initially",
          "severity": "high",
          "mitigation": "Comprehensive test suite including edge cases + manual security audit"
        }
      ],
      "contractChanges": [
        {
          "file": "src/lib/auth.ts",
          "type": "interface",
          "breaking": false,
          "description": "New auth interface for signup/login/logout"
        }
      ],
      "metadata": {
        "createdAt": "2025-12-30T10:05:00Z",
        "approved": false
      }
    }
  ]
}
